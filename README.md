# Better Synth 

## èµ›é¢˜èƒŒæ™¯

åœ¨å½“ä¸‹å¤§æ•°æ®ã€å¤§æ¨¡å‹æ—¶ä»£ï¼Œå¤§æ•°æ®æ˜¯é©±åŠ¨å¤§æ¨¡å‹çš„èƒ½æºã€‚å½“å‰å¤§æ¨¡å‹çš„è®­ç»ƒæ•°æ®ç»å¤§éƒ¨åˆ†æ¥æºäºäº’è”ç½‘ä¸Šçš„ä¿¡æ¯ï¼Œä½†éšç€å¤§æ¨¡å‹å°ºå¯¸ä¸æ€§èƒ½é€æ¸æå‡ï¼Œäº’è”ç½‘ä¸Šçš„æµ·é‡æ•°æ®ä¹Ÿå°†é€æ¸ä½¿ç”¨æ®†å°½ï¼Œå¹¶ä¸”å¯¹äºå¤šæ¨¡æ€å¤§æ¨¡å‹æ¥è¯´ï¼Œè¿™äº›æµ·é‡èµ„æºåœ¨è·å–åï¼Œä¹Ÿéœ€è¦æå¤§çš„é¢å¤–å¤„ç†å’ŒäººåŠ›æ ‡æ³¨æ‰å¯ä»¥è¾¾åˆ°å¯ç”¨äºè®­ç»ƒå¤§æ¨¡å‹çš„æ°´å‡†ã€‚å› æ­¤ï¼Œå¦‚ä½•å€ŸåŠ©å·²æœ‰çš„å¼ºå¤§çš„å¤§æ¨¡å‹ï¼Œåœ¨æœ‰é™çš„è®¡ç®—èµ„æºä¸‹ä¸ºæ–°çš„æ¨¡å‹è®­ç»ƒæµç¨‹é«˜æ•ˆåˆæˆä¼˜è´¨çš„è®­ç»ƒæ•°æ®æˆä¸ºäº†ä¸€ä¸ªæ–°å…´çš„å€¼å¾—å…³æ³¨çš„é—®é¢˜ã€‚â€œå¤©æ±  Better Synth - å¤šæ¨¡æ€å¤§æ¨¡å‹æ•°æ®åˆæˆæŒ‘æˆ˜èµ›â€æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹äº§ç”Ÿï¼Œè¯¥æ¯”èµ›æ—¨åœ¨é¼“åŠ±å‚èµ›è€…æ¢ç©¶åˆæˆæ•°æ®å¯¹äºå¤šæ¨¡æ€å¤§æ¨¡å‹è®­ç»ƒçš„å½±å“ï¼Œä»¥åŠä¿ƒä½¿å‚èµ›è€…è¿½æ±‚é«˜æ•ˆçš„æ•°æ®åˆæˆæ–¹æ³•ä¸ç­–ç•¥ï¼Œå…±åŒæ¨è¿›å¤šæ¨¡æ€å¤§æ¨¡å‹æ•°æ®åˆæˆä» 0-1 ä»¥åŠä» 1-100 çš„å‰æ²¿åˆ›æ–°æ¢ç´¢ã€‚

## èµ›é¢˜ç®€ä»‹
Better Synth æ˜¯ä¸€é¡¹ä»¥**æ•°æ®ä¸ºä¸­å¿ƒ**çš„æŒ‘æˆ˜èµ›ï¼Œè€ƒå¯Ÿå¦‚ä½•åˆæˆä¸æ¸…æ´—å›¾æ–‡æ•°æ®ä»¥åœ¨å¤šæ¨¡æ€å¤§æ¨¡å‹ä¸Šå–å¾—æ›´ä¼˜çš„å›¾ç‰‡ç†è§£èƒ½åŠ›ã€‚
æœ¬æ¬¡æ¯”èµ›åŸºäº Mini-Gemini æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œåªå…³æ³¨äºé¢„è®­ç»ƒï¼ˆæ¨¡æ€é—´å¯¹é½ï¼‰é˜¶æ®µçš„**æ•°æ®åˆæˆä¸æ¸…æ´—**ï¼ŒæŒ‡ä»¤å¾®è°ƒé˜¶æ®µä¸ºå›ºå®šæ•°æ®é›†ã€‚ä¸ºäº†é€‰æ‰‹æ›´é«˜æ•ˆåœ°è¿­ä»£æ•°æ®åˆæˆæ–¹æ¡ˆï¼Œæœ¬æ¬¡æ¯”èµ›é€‰ç”¨ MGM-2B è§„æ¨¡çš„æ¨¡å‹ä½œä¸ºæ¯”èµ›æ¨¡å‹ã€‚
ä¸»åŠæ–¹æä¾›å€™é€‰ç§å­æ•°æ®é›†ï¼Œè¦æ±‚å‚èµ›è€…åŸºäºç§å­æ•°æ®é›†è¿›è¡Œæ•°æ®åˆæˆä¸æ¸…æ´—ï¼Œäº§å‡ºä¸€ä»½åŸºäºç§å­æ•°æ®é›†çš„æ›´é«˜è´¨é‡ã€æ›´å¤šæ ·æ€§çš„æ•°æ®é›†ï¼Œå¹¶åœ¨ç»™å®šè®¡ç®—çº¦æŸä¸‹è¿›è¡Œè®­ç»ƒã€‚ä¸»åŠæ–¹æä¾›å¼€å‘å¥—ä»¶ï¼Œè¦æ±‚å‚èµ›è€…åœ¨ç»Ÿä¸€çš„æ¡†æ¶å’Œå‚æ•°è®¾ç½®ä¸‹è¿›è¡Œæ¨¡å‹è®­ç»ƒå’Œä»»åŠ¡è¯„æµ‹ï¼Œå…¬å¹³å¯¹æ¯”æ•°æ®å¯¼è‡´çš„æ€§èƒ½å·®å¼‚ã€‚æ•°æ®é›†äº§å‡ºæµç¨‹ä¸­å¿…é¡»åŒ…å«â€œåˆæˆâ€çš„è¿‡ç¨‹ï¼ŒæœªåŒ…å«çš„æ–¹æ¡ˆä¼šè¢«è®¤ä¸ºæ˜¯æ— æ•ˆæ–¹æ¡ˆã€‚

## èµ›é¢˜é“¾æ¥
[https://tianchi.aliyun.com/competition/entrance/532251/rankingList](https://tianchi.aliyun.com/competition/entrance/532251/rankingList)

## æœ¬æ–¹æ¡ˆæœ€ç»ˆRank: ğŸ¥‰ 3nd Place (Public LB & Private LB)  

1. ä¾èµ–å®‰è£…
- æ¨èä½¿ç”¨ conda ç¯å¢ƒ
```shell
conda create -n dj python=3.10
conda activate dj

bash install.sh
```

2. æ¯”èµ›èµ„æºä¸‹è½½
- ä¸‹è½½åŸºç¡€æ¨¡å‹ï¼Œç§å­/å¾®è°ƒ/è¯„æµ‹æ•°æ®é›†
- åŸºç¡€æ¨¡å‹ä¸å¾®è°ƒæ•°æ®é›†å‡å­˜æ”¾äºè®­ç»ƒç›®å½•ä¸­æŒ‡å®šä½ç½®
- ç§å­æ•°æ®é›†å­˜æ”¾äº`input`ç›®å½•
- è¯„æµ‹æ•°æ®é›†å­˜æ”¾äº`toolkit/eval`ç›®å½•
```shell
bash download.sh
```

3. æ•°æ®å¤„ç†ä¸åˆæˆ
- æ¯”èµ›è¦æ±‚ä½¿ç”¨ [data-juicer](https://github.com/modelscope/data-juicer) åŸºäºä¸Šä¸€æ­¥ä¸­ä¸‹è½½çš„**ç§å­æ•°æ®é›†**è¿›è¡Œæ•°æ®å¤„ç†ä¸åˆæˆ
- `processed_data.jsonl`éœ€ä¸ºæ ‡å‡†çš„`JSONL`æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
```json lines
{"images": ["images/00237/002375592.jpg"], "text": "<image>\nadorable pink and gray elephant themed party favour boxes with tissue fillers <|__dj__eoc|>", "id": "002375592"}
{"images": ["images/00199/001999195.jpg"], "text": "<image>\nbreccinano adult dog food for all ages with turkey, lamb and venisi <|__dj__eoc|>", "id": "001999195"}
...
```

4. æ‰§è¡Œæ¨¡å‹è®­ç»ƒ/æ¨ç†
- æ¨¡å‹è®­ç»ƒä¸æ¨ç†
```shell
cd toolkit/

# è¯·æ ¹æ®è‡ªèº«éœ€æ±‚ä¿®æ”¹è®­ç»ƒè„šæœ¬train_mgm_2b_stage_1.shå†…çš„å‚æ•°
# æ‚¨åªèƒ½ä¿®æ”¹ä»¥ä¸‹èŒƒå›´å†…çš„å‚æ•°

# ä¿®æ”¹å®Œæ¯•åæ‰§è¡Œè®­ç»ƒä¸æ¨ç†è„šæœ¬
bash train_mgm_2b_stage_1.sh
```
- è®­ç»ƒä¸æ¨ç†ç»“æŸåï¼Œä¼šåœ¨`output`ç›®å½•ä¸­äº§å‡ºè®­ç»ƒå¥½çš„æ¨¡å‹ä»¥åŠè¯„æµ‹é›†æ¨ç†ç»“æœ
  - è®­ç»ƒåçš„æ¨¡å‹å­˜æ”¾äºï¼š`output/training_dirs`
  - æ¨ç†ç»“æœå­˜æ”¾äºï¼š`output/eval_results`

5.æ€è·¯

<b><font class=center>èµ›é¢˜</font></b>

Better Synth æ˜¯ä¸€é¡¹ä»¥æ•°æ®ä¸ºä¸­å¿ƒçš„æŒ‘æˆ˜èµ›ï¼Œè€ƒå¯Ÿå¦‚ä½•åˆæˆä¸æ¸…æ´—å›¾æ–‡æ•°æ®ä»¥åœ¨å¤šæ¨¡æ€å¤§æ¨¡å‹ä¸Šå–å¾—æ›´ä¼˜çš„å›¾ç‰‡ç†è§£èƒ½åŠ›ã€‚åœ¨ç»™å®šçš„ç§å­æ•°æ®é›†çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡é«˜æ•ˆçš„æ•°æ®åˆæˆæ–¹æ³•ä¸æ¨¡å‹ç”Ÿæˆå‡ºæ›´ä¼˜çš„æ•°æ®ï¼Œå¹¶åœ¨ç»™å®šè®¡ç®—é‡çš„çº¦æŸä¸‹ï¼Œå®ç°å¯¹å›¾åƒç†è§£å¤šæ¨¡æ€å¤§æ¨¡å‹çš„é«˜æ•ˆè®­ç»ƒã€‚

 <b>1. æ•°æ®åˆ†æ</b>
  - <b>å›¾æ–‡åŒ¹é…ç›¸ä¼¼åº¦</b>
 ä½¿ç”¨CLIPç»Ÿè®¡ä¸€ä¸‹æ•°æ®é›†ä¸­å›¾æ–‡åŒ¹é…çš„ç›¸ä¼¼åº¦ç›´æ–¹å›¾åˆ†å¸ƒã€‚
 ![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172623128877543621726231288775_hb36njifnu.jpeg)

```
Maximum Score: 0.4763159155845642
Average Score: 0.3232152164191008
Standard Deviation: 0.03921227440944236
3 sigma åŒºé—´: (0.2055783931907737, 0.44085203964742786)
```

åœ¨è¿™é‡Œä½¿ç”¨K-sigma è¿›è¡Œå¼‚å¸¸ç‚¹ä¹‹å¤–çš„è¿‡æ»¤æ•ˆæœä¸å¤ªç†æƒ³ï¼ŒæŠŠå¹³å‡å€¼0.3232ä»¥ä¸‹çš„ä½è´¨é‡ï¼Œå›¾æ–‡ç›¸å…³æ€§ä¸å¤§çš„æ•°æ®é›†è¿›è¡Œè¿‡æ»¤æ˜¯æ¯”è¾ƒworkçš„ã€‚

  - <b>æ–‡å­—é•¿åº¦åˆ†æ</b>
  ç®€å•ç»Ÿè®¡ä¸€ä¸‹æ–‡æœ¬å•è¯æ•°é‡ç›´æ–¹å›¾åˆ†å¸ƒï¼ˆç”±äºæ˜¯è‹±è¯­æ•°æ®é›†ï¼Œæˆ‘æ˜¯ä»¥ç©ºæ ¼åŒºåˆ†çš„ç®€å•é€»è¾‘ï¼‰
  å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®é›†åŸæœ¬captionçš„æ€»ä½“é•¿åº¦ä¹ŸåçŸ­ï¼Œå› æ­¤ä¸è¿›è¡Œrecapitionæ•ˆæœä¹Ÿä¸ä¼šå·®ï¼ˆç”±äºæ¨¡å‹å‚æ•°é‡å°‘ï¼ŒCaptionè¶Šç®€å•è¶Šç›´è§‚è¶Šå¥½ï¼Œä¸éœ€è¦å›¾ç‰‡ä¸­å…¶ä»–å¤æ‚æ¨ç†é€»è¾‘æˆ–å…¶ä»–é—´æ¥ä¿¡æ¯ï¼‰ã€‚
  ![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172623158123115971726231581231_fllwxhmdxh.jpeg)

```
Maximum word count: 23
Minimum word count: 3
Average word count: 10.79
æ ‡å‡†å·®: 3.52
```

  - <b>å›¾ç‰‡å°ºå¯¸åˆ†æ</b>
  ç”±äºå­˜åœ¨ä¸¤ä¸ªå¼‚å¸¸æ•°æ®ï¼ˆä¸€ä¸ªå®½ä¸º12192ï¼Œä¸€ä¸ªé«˜ä¸º3033ï¼‰ï¼ŒæŠŠæ•°æ®èŒƒå›´æ‹‰å¤§äº†ï¼Œè€Œç»å¤§æ•°å›¾ç‰‡çš„å°ºå¯¸æ˜¯æ­£å¸¸çš„ï¼Œå¯¼è‡´ç”»å‡ºæ¥çš„å›¾ä¸å¥½çœ‹ã€‚
  ![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172623285697282141726232856972_mecmq0gazl.png)
  ![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172624003140119171726240031401_giauiehhfz.png)
```
Maximum image width: 12192
Minimum image width: 336
Average image width: 403.1335
```

![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172624000503758171726240005037_ac2wj1rqbs.png)

```
Maximum image height: 3033
Minimum image height: 336
Average image height: 367.7052
```
ç”±äºæœ¬æ¬¡æ¯”èµ›åŸºäº[Mini-Gemini](https://github.com/dvlab-research/MGM?spm=a2c22.12281978.0.0.376b2c2bOxjWmv)è¿›è¡Œè®­ç»ƒï¼Œè€Œè¯¥æ¨¡å‹ä¸è®­ç»ƒçš„åƒç´ å¤§å°ä¸º336ï¼ŒCLIPé¢„è®­ç»ƒçš„åƒç´ å¤§å°ä¸º768ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©å°†å›¾ç‰‡åƒç´ å°äº336å¤§äº768çš„è¿›è¡Œå»é™¤ã€‚
 
 2. ç»„åˆç®—å­
 ç”±äºæ ¸å¿ƒæ˜¯æ¨¡æ€å¯¹é½ï¼Œæ–‡æœ¬å›¾ç‰‡æ›´ä¸€è‡´çš„è¿›è¡Œè®­ç»ƒæ•ˆæœä¼šæ›´å¥½ï¼Œå› æ­¤CLIPå¿…ä¸å¯å°‘ã€‚
 åœ¨åˆèµ›æœ€åä¸€å¤©ä½¿ç”¨Stable Diffusionè¿›è¡Œå›¾ç‰‡çš„é‡æ–°ç”Ÿæˆæ•ˆæœå¹¶ä¸å¥½ã€‚
 ä½¿ç”¨LLaVA-1.5æ•ˆæœä¸€èˆ¬ï¼Œä½¿ç”¨promptï¼šâ€œPlease describe the main elements in the image in concise language based on the content. For example, 'A little girl wearing blue clothes is swinging in the park.' Pay attention to maintaining consistency and conciseness in the description, only describe based on the surface content of the image, without delving into the meaning behind the image.â€

è¾¾åˆ°2åˆ†ï¼Œä½†captionä»ç„¶è¾ƒé•¿ï¼Œå¯èƒ½æ˜¯promptè®¾è®¡çš„è¿˜ä¸å¤Ÿå¥½ï¼Œä½¿ç”¨BLIP-2è™½ç„¶ç”Ÿæˆçš„captionè™½ç„¶çœ‹èµ·æ¥ä¸å¤§è¡Œï¼Œä½†è®­ç»ƒåæ•ˆæœåè€Œè¿˜è¡Œã€‚
 å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨BLIP-2+watermarkæ•ˆæœæ›´å¥½ï¼Œè¿™æ˜¯å› ä¸ºBLIP-2å¯¹äºæœ‰æ°´å°çš„å›¾ç‰‡ç”Ÿæˆçš„captionä¼šåœ¨æœ€ååŒ…å«ä¸å¿…è¦çš„ä¿¡æ¯stock photo![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172623969726649371726239697266_rvyny5y5cf.jpeg)

ä½¿ç”¨Aestheticeå»é™¤ç¾å­¦è¯„åˆ†ä½çš„æ•ˆæœä¸å¤§å¥½ï¼Œä½¿ç”¨NSFWå»é™¤æš´åŠ›ã€è‰²æƒ…å›¾ç‰‡æ•ˆæœä¹Ÿä¸å¤§å¥½ï¼ŒId_scoreï¼ŒGrounding_recallï¼ŒAction numï¼Œperplexity scoreç­‰æ•ˆæœä¸€èˆ¬

![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/172630001664645271726300016646_7jztugddfz.jpeg)

é€šè¿‡æµ‹é‡ä¸åŒç®—å­çš„è¿è¡Œé€Ÿåº¦ï¼ˆå•ä½ï¼šexamples/sï¼‰ï¼Œè·å¾—æœ€ä½³é¡ºåºï¼Œå…·ä½“æ–¹æ¡ˆè§solution

3. æ€è·¯æŠ€å·§
 - è®­ç»ƒè¿‡ç¨‹å¹¶ä¸ç¨³å®šï¼Œä¸€æ ·çš„è®¾ç½®å¯èƒ½ä»0.8æˆ–è€…é£™å‡åˆ°1.5ï¼Œå› æ­¤æœ€å¥½å¤šè·‘å‡ ébaseline
 -  æ•°æ®é‡å¯¹æ¨¡å‹èƒ½åŠ›æå‡æœ‰å¾ˆå¤§å¸®åŠ©ï¼Œå› æ­¤æ¸…æ´—ç­›é€‰å®Œæœ€å¥½è¿›è¡Œè¡¥å……æˆ–è€…é‡å¤ï¼Œè¾¾åˆ°çº¦æŸçš„ä¸Šé™é‡
 -  é«˜è´¨é‡é‡å¤æ•°æ®å¯¹æ¨¡å‹æœ‰å¾ˆå¤§å¸®åŠ©ï¼Œæˆ‘ä»¬çš„æœ€ä½³æˆç»©é‡å¤äº†3.76æ¬¡ï¼ˆåœ¨toolkit/training/preprocess/check_sample_number.pyä»£ç è¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨whileå¾ªç¯å’Œrandom.sampleè¿›è¡Œéšæœºé‡‡æ ·ï¼Œè¡¥å……è‡³ä¸Šé™ï¼‰
```
ä»£ç æ ·ä¾‹å¦‚ä¸‹ï¼š
            if sample_num < len(ds):
                logger.info(f'Sampled number from the input dataset: {sample_num}')
                sampled_ds = random.sample(ds, sample_num)
            else:
                logger.info(f'Need to sample more than the input dataset size.')
                sampled_ds = []
                while len(sampled_ds) < sample_num:
                    num_to_sample = min(sample_num - len(sampled_ds), len(ds))
                    sampled_ds.extend(random.sample(ds, num_to_sample))
                logger.info(f'Sampled number from the input dataset: {sample_num}')
            writer.write_all(sampled_ds)
```
 - ä¸åŒç®—å­é¡ºåºå¯¼è‡´çš„ç»“æœæœ‰ä¸€å®šåŒºåˆ«ï¼ŒåŒ…æ‹¬é€Ÿåº¦ä¹Ÿä¸ä¸€æ ·ï¼Œä¼˜å…ˆä½¿ç”¨è½»é‡çº§ç®—å­æ›´å¿«ï¼Œä½†è‹¥æ˜¯è€ƒè™‘æ¨¡å‹ç²¾åº¦ï¼Œå¯ä»¥æ€è€ƒå…ˆcationå†è¿‡æ»¤è¿˜æ˜¯å…ˆè¿‡æ»¤å†captionçš„åŒºåˆ«ã€‚æˆ–è€…ä½¿ç”¨ <b>æ¸…æ´—æ•°æ®â†’åˆæˆæ•°æ®â†’æ¸…æ´—æ•°æ®</b> çš„æ–¹å¼
 - æ•°æ®å¤šæ ·æ€§å¾ˆé‡è¦